<!DOCTYPE html>
<html lang="vi">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Thêm sinh viên</title>
     <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
     <?php
     if (!isset($_SESSION)) 
          session_start(); 
     ?>
     <?php include 'components/header.phtml'; ?>
     
     <main class="main-content">
          <div class="container">
               <h2 class="page-title">Thêm sinh viên mới</h2>
               
               <?php if(isset($_SESSION['insert_status'])):?>
                    <div class="<?php echo $_SESSION['insert_status'] === 'success' ? 'alert alert-success' : 'alert alert-error'; ?>">
                         <?php if($_SESSION['insert_status'] === "success"):?>
                              <p>Thêm sinh viên mới thành công</p>
                              <p>Bạn có muốn xem danh sách sinh viên mới?</p>
                              <form action="../Controller/C_Student.php" method="GET" style="margin-top: 1rem;">
                                   <button type="submit" class="btn btn-primary">Xem danh sách</button>
                              </form>
                         <?php else:?>
                              <?php if(isset($_SESSION['error'])): ?>
                                   <p><?=htmlspecialchars($_SESSION['error']['type'])?> : <?=htmlspecialchars($_SESSION['error']['message'])?></p>
                                   <?php unset($_SESSION['error']); ?>
                              <?php else: ?>
                                   <p>Không thể thêm sinh viên. Vui lòng thử lại.</p>
                              <?php endif; ?>
                         <?php endif;?>
                    </div>
               <?php unset($_SESSION['insert_status']); endif;?>
               
               <form action="../Controller/C_Student.php" method="POST" onsubmit="return validateForm()">
                    <div class="form-group">
                         <label for="id">ID</label>
                         <input type="text" name="id" placeholder="1001" id="id" required onblur="validateField(this,'id')">
                         <label for="" id="idError" class="error-message" style="visibility: hidden;"></label>
                    </div>
                    
                    <div class="form-group">
                         <label for="name">Họ và tên</label>
                         <input type="text" name="name" placeholder="Nguyễn Văn A" id="name" required onblur="validateField(this,'name')">
                         <label for="" id="nameError" class="error-message" style="visibility: hidden;"></label>
                    </div>
                    
                    <div class="form-group">
                         <label for="age">Tuổi</label>
                         <input type="text" name="age" placeholder="20" id="age" required onblur="validateField(this, 'age')">
                         <label for="" id="ageError" class="error-message" style="visibility: hidden;"></label>
                    </div>
                    
                    <div class="form-group">
                         <label for="university">Trường</label>
                         <input type="text" name="university" placeholder="Trường Đại học Bách khoa" id="university" required onblur="validateField(this,'university')">
                         <label for="" id="universityError" class="error-message" style="visibility: hidden;"></label>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                         <button type="submit" name="insert" class="btn btn-primary">Thêm</button>
                         <button type="reset" name="reset" value="Reset" onclick="resetFormErrors()" class="btn btn-secondary">Đặt lại</button>
                         <a href="../index.php" class="btn btn-secondary">Trang chủ</a>
                    </div>
               </form>
          </div>
     </main>
     
     <?php include 'components/footer.phtml'; ?>
<script>
     function resetFormErrors() {
          var fieldName = ['id', 'name', 'age', 'university'];
          for (const field of fieldName) {
               document.getElementById(field).classList.remove('is-invalid');
               document.getElementById(field+"Error").style.visibility = "hidden";
          }
          return true;
     }

     const validationRules = {
          id: {
               regex: /^\d{4,}$/, 
               errorMessage: "ID phải là số và có tối thiểu 4 chữ số."
          },
          name: {
               regex: /^[^\t\n\r\f\v@#\$%\^&\*+=\[\]\{\}<>]+$/, 
               errorMessage: "Tên không hợp lệ. Vui lòng không sử dụng ký tự đặc biệt."
          },
          age: {
               regex: /^\d{1,3}$/, 
               errorMessage: "Tuổi không hợp lệ (tổi đa 3 chữ số)."
          },
          university: {
               regex: /^[^\t\n\r\f\v@#\$%\^&\*+=\[\]\{\}<>]+$/, 
               errorMessage: "Tên trường không hợp lệ. Vui lòng không sử dụng ký tự đặc biệt."
          }
     };

     function validateField(inputElement, fieldName) {
          var value = inputElement.value.trim();
          const errorDisplay = document.getElementById(fieldName + "Error");
          const rule = validationRules[fieldName];
          let isValid = true;
          let message = "";

          if (value === "") {
               isValid = false;
               message = "Vui lòng điền " + fieldName;
          } else if (rule && rule.regex && !rule.regex.test(value)) {
               isValid = false;
               message = rule.errorMessage;
          } else if (fieldName === 'age') {
               const ageValue = parseInt(value, 10);
               const minAge = 16;
               const maxAge = 150;

               if (isNaN(ageValue) || ageValue < minAge || ageValue > maxAge) {
                    isValid = false;
                    message = `Tuổi phải nằm trong khoảng từ ${minAge} đến ${maxAge}.`;
               }
          }

          if (!isValid) {
               errorDisplay.style.visibility = "visible";
               errorDisplay.textContent = message;
               errorDisplay.style.color = 'red';
               inputElement.classList.add('is-invalid');
          } else {
               errorDisplay.style.visibility = "hidden";
               inputElement.classList.remove('is-invalid');
          }

          return isValid;
     }

     function validateForm() {
          const fields = ['id', 'name', 'age', 'university']; 
          let isFormValid = true;

          for (const fieldName of fields) {
               const inputElement = document.getElementById(fieldName);
               if (!validateField(inputElement, fieldName)) {
                    isFormValid = false;
               }
          }

          if (!isFormValid) {
               alert("Vui lòng sửa các lỗi trước khi gửi Form.");
          }
          return isFormValid;
     }
</script>
</html>