<!DOCTYPE html>
<html lang="vi">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Tìm kiếm sinh viên</title>
     <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
     <?php include 'components/header.phtml'; ?>
     
     <main class="main-content">
          <div class="container">
               <h2 class="page-title">Tìm kiếm sinh viên</h2>
               
               <form action="../Controller/C_Student.php" method="POST" onsubmit="return validateSearchForm()">
                    <div class="form-group">
                         <label for="criteria">Tiêu chí tìm kiếm</label>
                         <select name="criteria" id="criteria" onchange="updatePlaceholder()">
                              <option value="id">ID</option>
                              <option value="name">Họ và tên</option>
                              <option value="age">Tuổi</option>
                              <option value="university">Trường</option>
                         </select>
                    </div>
                    
                    <div class="form-group">
                         <label for="searchValue">Giá trị tìm kiếm</label>
                         <input type="text" name="searchValue" id="searchValue" placeholder="1001">
                         <div id="searchError" class="error-message"></div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                         <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                         <button type="reset" value="Reset" onclick="resetError()" class="btn btn-secondary">Đặt lại</button>
                         <a href="javascript:history.back()" class="btn btn-secondary">Quay lại</a>
                         <a href="../index.php" class="btn btn-secondary">Trang chủ</a>
                    </div>
               </form>
               
               <?php if(isset($_SESSION['search_status'])):?>
                    <?php if($_SESSION['search_status'] == 'success'): ?>
                         <div class="container" style="margin-top: 2rem;">
                              <h3 style="color: var(--navy-blue); margin-bottom: 1rem;">Kết quả tìm kiếm:</h3>
                              <table>
                                   <thead>
                                        <tr>
                                             <th>STT</th>
                                             <th>ID</th>
                                             <th>Họ và tên</th>
                                             <th>Tuổi</th>
                                             <th>Trường</th>
                                        </tr>
                                   </thead>
                                   <tbody>
                                        <?php $count = 1; ?>
                                        <?php foreach($students as $student) : ?>
                                             <tr>
                                                  <td style="text-align: center;"><?=$count++?></td>
                                                  <td style="text-align: center;"><?=$student->id?></td>
                                                  <td><?=$student->name?></td>
                                                  <td style="text-align: center;"><?=$student->age?></td>
                                                  <td><?=$student->university?></td>
                                             </tr>
                                        <?php endforeach; ?>
                                   </tbody>
                              </table>
                         </div>
                    <?php elseif($_SESSION['search_status'] == 'error'): ?>
                         <div class="alert alert-error" style="margin-top: 2rem;">
                              <h3>Không tìm thấy</h3>
                              <?php if(isset($_SESSION['error'])): ?>
                                   <p><?=htmlspecialchars($_SESSION['error']['type'])?> : <?=htmlspecialchars($_SESSION['error']['message'])?></p>
                                   <?php unset($_SESSION['error']); ?>
                              <?php else: ?>
                                   <p>Không tìm thấy kết quả phù hợp.</p>
                              <?php endif; ?>
                         </div>
                    <?php endif; ?>
               <?php unset($_SESSION['search_status']); endif; ?>
          </div>
     </main>
     
     <?php include 'components/footer.phtml'; ?>
<script>
     const validationRules = {
          id: {
               regex: /^\d{4,}$/, 
               errorMessage: "ID phải là số và có tối thiểu 4 chữ số.",
               placeholder: "1001"
          },
          name: {
               regex: /^[^\t\n\r\f\v@#\$%\^&\*+=\[\]\{\}<>]+$/, 
               errorMessage: "Tên không hợp lệ. Vui lòng không sử dụng ký tự đặc biệt.",
               placeholder: "Nguyễn Văn A"
          },
          age: {
               regex: /^\d{1,3}$/, 
               errorMessage: "Tuổi phải là số và nằm trong khoảng từ 16 đến 150.",
               placeholder: "20"
          },
          university: {
               regex: /^[^\t\n\r\f\v@#\$%\^&\*+=\[\]\{\}<>]+$/, 
               errorMessage: "Tên trường không hợp lệ. Vui lòng không sử dụng ký tự đặc biệt.",
               placeholder: "Trường Đại học Bách khoa"
          }
     };

     function updatePlaceholder() {
          const criteria = document.getElementById('criteria').value;
          const searchInput = document.getElementById('searchValue');
          searchInput.placeholder = validationRules[criteria].placeholder;
          resetError();
     }

     function resetError() {
          const errorDisplay = document.getElementById('searchError');
          const searchInput = document.getElementById('searchValue');
          errorDisplay.style.display = 'none';
          searchInput.classList.remove('is-invalid');
     }

     function validateSearchForm() {
          const criteria = document.getElementById('criteria').value;
          const searchValue = document.getElementById('searchValue').value.trim();
          const errorDisplay = document.getElementById('searchError');
          const rule = validationRules[criteria];

          if (searchValue === "") {
               return true;
          }

          let isValid = true;
          let message = "";

          if (criteria === 'age') {
               const ageValue = parseInt(searchValue, 10);
               const minAge = 16;
               const maxAge = 150;

               if (!rule.regex.test(searchValue) || isNaN(ageValue) || ageValue < minAge || ageValue > maxAge) {
                    isValid = false;
                    message = `Tuổi phải là số và nằm trong khoảng từ ${minAge} đến ${maxAge}.`;
               }
          } else if (!rule.regex.test(searchValue)) {
               isValid = false;
               message = rule.errorMessage;
          }

          if (!isValid) {
               errorDisplay.textContent = message;
               errorDisplay.style.display = 'block';
               document.getElementById('searchValue').classList.add('is-invalid');
               return false;
          }

          return true;
     }

     updatePlaceholder();
</script>
</html>